/* enable predefined math constants M_* for MS Visual Studio */
#if defined(_MSC_VER) || defined(_WIN32)
#ifndef _USE_MATH_DEFINES
#define _USE_MATH_DEFINES
#endif
#endif

#include <cmath>
#include <cstdint>
#include <errno.h>

#include "proj.h"
#include "proj_internal.h"

PROJ_HEAD(dymaxion, "Dymaxion") "\n\tMisc, Sph&Ell";


namespace { // anonymous namespace
    struct pj_face {
        const PJ_XYZ p1;
        const PJ_XYZ p2;
        const PJ_XYZ p3;
    };
} // anonymous namespace


constexpr pj_face ico_faces[23] = {
    {
        { 0.42015243,  0.07814525,  0.90408255},
        { 0.51883673,  0.83542038,  0.18133184},
        { 0.99500944, -0.0913478 ,  0.04014718}
    }, {
        {  0.42015243,  0.07814525,  0.90408255},
        { -0.41468223,  0.65596241,  0.63067581},
        { 0.51883673,  0.83542038,  0.18133184}
    }, {
        {  0.42015243,  0.07814525,  0.90408255},
        { -0.51545596, -0.3817169 ,  0.76720099},
        { -0.41468223,  0.65596241,  0.63067581}
    }, {
        {  0.42015243,  0.07814525,  0.90408255},
        { 0.3557814 , -0.84358   ,  0.40223423},
        { -0.51545596, -0.3817169 ,  0.76720099}
    }, {
        {  0.42015243,  0.07814525,  0.90408255},
        { 0.99500944, -0.0913478 ,  0.04014718},
        { 0.3557814 , -0.84358   ,  0.40223423}
    }, {
        {  0.99500944, -0.0913478 ,  0.04014718},
        { 0.51883673,  0.83542038,  0.18133184},
        { 0.51545596,  0.3817169 , -0.76720099}
    }, {
        {  0.51545596,  0.3817169 , -0.76720099},
        { 0.51883673,  0.83542038,  0.18133184},
        { -0.3557814 ,  0.84358   , -0.40223423}
    }, {
        { -0.3557814 ,  0.84358   , -0.40223423},
        { 0.51883673,  0.83542038,  0.18133184},
        { -0.41468223,  0.65596241,  0.63067581}
    }, {
        { -0.51545596, -0.3817169 ,  0.76720099},
        { -0.99500944,  0.0913478 , -0.04014718},
        { -0.41468223,  0.65596241,  0.63067581}
    }, {
        { -0.51545596, -0.3817169 ,  0.76720099},
        { -0.51883673, -0.83542038, -0.18133184},
        { -0.99500944,  0.0913478 , -0.04014718}
    }, {
        { -0.51545596, -0.3817169 ,  0.76720099},
        { 0.3557814 , -0.84358   ,  0.40223423},
        { -0.51883673, -0.83542038, -0.18133184}
    }, {
        { -0.51883673, -0.83542038, -0.18133184},
        { 0.3557814 , -0.84358   ,  0.40223423},
        { 0.41468223, -0.65596241, -0.63067581}
    }, {
        {  0.41468223, -0.65596241, -0.63067581},
        { 0.3557814 , -0.84358   ,  0.40223423},
        { 0.99500944, -0.0913478 ,  0.04014718}
    }, {
        {  0.51545596,  0.3817169 , -0.76720099},
        { 0.41468223, -0.65596241, -0.63067581},
        { 0.99500944, -0.0913478 ,  0.04014718}
    }, {
        { -0.42015243, -0.07814525, -0.90408255},
        { -0.3557814 ,  0.84358   , -0.40223423},
        { -0.99500944,  0.0913478 , -0.04014718}
    }, {
        { -0.42015243, -0.07814525, -0.90408255},
        { -0.99500944,  0.0913478 , -0.04014718},
        { -0.51883673, -0.83542038, -0.18133184}
    }, {
        { -0.42015243, -0.07814525, -0.90408255},
        { -0.51883673, -0.83542038, -0.18133184},
        { 0.41468223, -0.65596241, -0.63067581}
    }, {
        { -0.42015243, -0.07814525, -0.90408255},
        { 0.41468223, -0.65596241, -0.63067581},
        { 0.51545596,  0.3817169 , -0.76720099}
    }, {
        { -0.3557814 ,  0.84358   , -0.40223423},
        { -0.38796691,  0.38271738, -0.65315839},
        { 0.51545596,  0.3817169 , -0.76720099}
    }, {
        { -0.42015243, -0.07814525, -0.90408255},
        { 0.51545596,  0.3817169 , -0.76720099},
        { -0.38796691,  0.38271738, -0.65315839}
    }, {
        { -0.99500944,  0.0913478 , -0.04014718},
        { -0.3557814 ,  0.84358   , -0.40223423},
        { -0.58849102,  0.53029673,  0.0627648 }
    }, {
        { -0.3557814 ,  0.84358   , -0.40223423},
        { -0.41468223,  0.65596241,  0.63067581},
        { -0.58849102,  0.53029673,  0.0627648 }
    }, {
        { -0.99500944,  0.0913478 , -0.04014718},
        { -0.58849102,  0.53029673,  0.0627648 },
        { -0.41468223,  0.65596241,  0.63067581}
    }
};
constexpr PJ_XYZ ico_centers[23] = {
    { 0.6446662 ,  0.27407261,  0.37518719},
    { 0.17476898,  0.52317601,  0.57203007},
    {-0.16999525,  0.11746359,  0.76731978},
    { 0.08682596, -0.38238388,  0.69117259},
    { 0.59031442, -0.28559418,  0.44882132},
    { 0.67643404,  0.37526316, -0.18190733},
    { 0.22617043,  0.68690576, -0.32936779},
    {-0.08387563,  0.77832093,  0.13659114},
    {-0.64171587,  0.12186443,  0.45257654},
    {-0.67643404, -0.37526316,  0.18190733},
    {-0.22617043, -0.68690576,  0.32936779},
    { 0.08387563, -0.77832093, -0.13659114},
    { 0.58849102, -0.53029673, -0.0627648 },
    { 0.64171587, -0.12186443, -0.45257654},
    {-0.59031442,  0.28559418, -0.44882132},
    {-0.6446662 , -0.27407261, -0.37518719},
    {-0.17476898, -0.52317601, -0.57203007},
    { 0.16999525, -0.11746359, -0.76731978},
    {-0.07609745,  0.53600476, -0.6075312 },
    {-0.09755446,  0.22876301, -0.77481398},
    {-0.64642729,  0.48840818, -0.12653887},
    {-0.45298488,  0.67661305,  0.09706879},
    {-0.66606089,  0.42586898,  0.21776448}
};
constexpr PJ_XYZ ico_normals[23] = {
    { 0.81125347,  0.34489532,  0.47213877},
    { 0.21993078,  0.65836918,  0.71984754},
    {-0.21392348,  0.14781718,  0.96560179},
    { 0.10926253, -0.48119516,  0.86977751},
    { 0.74285673, -0.35939417,  0.56480059},
    { 0.8512304 ,  0.47223438, -0.22891374},
    { 0.28461481,  0.8644081 , -0.41447926},
    {-0.10554981,  0.97944573,  0.17188746},
    {-0.80754076,  0.15335525,  0.5695262 },
    {-0.8512304 , -0.47223438,  0.22891374},
    {-0.28461481, -0.8644081 ,  0.41447926},
    { 0.10554981, -0.97944573, -0.17188746},
    { 0.74056215, -0.66732996, -0.07898376},
    { 0.80754076, -0.15335525, -0.5695262 },
    {-0.74285673,  0.35939417, -0.56480059},
    {-0.81125347, -0.34489532, -0.47213877},
    {-0.21993078, -0.65836918, -0.71984754},
    { 0.21392348, -0.14781718, -0.96560179},
    {-0.09351474,  0.65868628, -0.7465838 },
    {-0.11988286,  0.28112261, -0.95215449},
    {-0.78831255,  0.5956096 , -0.15431307},
    {-0.55241119,  0.82512383,  0.11837456},
    {-0.81225557,  0.51934358,  0.26556192}
};
constexpr double ico_dym_trans[23][2][4] = {
    {
        {3676785.5510927686, -3835017.5258469363, -3516181.100781365, 13536571.967011793},
        {597946.1042109424, 4588467.130704259, -4379277.462052473, 23446030.407177}
    }, {
        {6186177.998246177, -1393567.906883936, -615475.9397151419, 9668980.022865457},
        {597946.093114201, 4588467.19100263, -4379277.400388917, 23446030.35137834}
    }, {
        {6193487.4205306955, -412638.4248002627, 1435299.1378493956, 7735184.010119925},
        {610606.3190418222, 6287486.747151732, -827230.8805747802, 20096597.543368153}
    }, {
        {6320833.944116932, -6999.892727576209, -797903.6645324827, 9668980.01852922},
        {390035.65327668283, 5584900.236424718, 3040789.8291663616, 16747164.616387902}
    }, {
        {1785817.7590237681, -3817376.0879736473, -4777879.8689040495, 15470367.924944565},
        {3873198.442246702, 4557911.138766957, -2193951.03617877, 20096597.49643075}
    }, {
        {1653953.7215915888, -4829262.34292155, -3812125.819798014, 15470368.002101175},
        {-2905701.4190057977, 2866384.5748423464, -4891868.701844473, 26795463.40708426}
    }, {
        {6107473.601907308, -1644266.3344992409, 764719.3344694556, 9668979.981535126},
        {-20484.64090943463, -2749071.518667839, -5747332.184563468, 30144896.19948345}
    }, {
        {6325351.40269263, 599247.8045318229, 469545.1276272928, 7735184.023318606},
        {356890.77120627166, 1136808.9882550093, -6258588.8944518985, 26795463.32486729}
    }, {
        {3707748.665652811, 320266.29512553854, 5171041.496392702, 3867592.035741229},
        {610606.2571372315, 6287486.77106971, -827230.7444765394, 20096597.416174263}
    }, {
        {3343388.1054673023, -4896993.030290109, 2330419.6578763095, 3867592.0439363136},
        {20484.769920770817, 2749071.5830884464, 5747332.153289897, 13397731.73801166}
    }, {
        {6107473.60190731, -1644266.3344992383, 764719.3344694556, 7735183.976051465},
        {20484.640909436934, 2749071.5186678423, 5747332.184563471, 13397731.622928448}
    }, {
        {6325351.402692626, 599247.8045318197, 469545.1276272917, 9668979.934267987},
        {-356890.771206269, -1136808.988255014, 6258588.894451901, 10048298.748312276}
    }, {
        {4266333.312707111, 4606685.514783113, 1080041.5952454251, 13536571.999992047},
        {-356890.7685546608, -1136809.0066234802, 6258588.89126666, 10048298.733154824}
    }, {
        {3707748.6656528125, 320266.2951255404, 5171041.496392703, 13536571.921845356},
        {-610606.2571372343, -6287486.771069713, 827230.7444765412, 3349432.839619261}
    }, {
        {2461379.3653720734, 5855954.878351068, 488922.6024620175, 1933795.9726568952},
        {3483162.766967333, -1026989.0986009572, -5234740.860790558, 30144896.267866686}
    }, {
        {1320556.259205771, -5891237.862543248, 2034474.981967402, 1933795.9952873993},
        {-3483162.743619373, 1026989.0359898619, 5234740.88860963, 10048298.745932998}
    }, {
        {6186177.998246178, -1393567.906883938, -615475.9397151434, 7735183.934721128},
        {-597946.0931142012, -4588467.191002626, 4379277.400388914, 6698865.774823346}
    }, {
        {6193487.420530697, -412638.4248002642, 1435299.1378493954, 9668979.94746666},
        {-610606.3190418243, -6287486.747151733, 827230.8805747859, 3349432.9668131615}
    }, {
        {3631143.294565724, 4247670.019959572, 3292753.7141836006, 4834490.01017019},
        {5202228.852835585, -2460476.189043276, -2822411.933114077, 32936090.315075427}
    }, {
        {6320833.984249294, -6999.986858507935, -797903.6226051609, 7735183.986468951},
        {-236523.47825744975, -6260972.143136178, -1818765.4625549014, 1116477.6505621031}
    }, {
        {3665612.680171031, 5148002.543997674, 1144110.7942403506, 3222993.3353615967},
        {1397369.4993098697, 199220.39584036605, -6369559.895786125, 27911940.952937342}
    }, {
        {5467774.722326167, 3524051.3707974004, 951903.3183405161, 5156789.374365881},
        {356890.8085771865, 1136808.9426368838, -6258588.900606924, 26795463.37416993}
    }, {
        {2424810.9279973777, 777520.1747496846, 5896048.635731078, 2578394.7320210026},
        {2832719.751595245, 5495499.807718434, -2082980.0653286842, 22329552.792623065}
    }
};

constexpr pj_face dymaxion_faces[23] = {
    {
        {11602775.971724393, 20096597.491866, 1.0},
        {11602775.971724393, 26795463.322488002, 1.0},
        {17404163.95758659, 23446030.407177, 1.0}
    }, {
        {11602775.971724393, 20096597.491866, 1.0},
        {5801387.985862196, 23446030.407177, 1.0},
        {11602775.971724393, 26795463.322488002, 1.0}
    }, {
        {11602775.971724393, 20096597.491866, 1.0},
        {5801387.985862196, 16747164.576555002, 1.0},
        {5801387.985862196, 23446030.407177, 1.0}
    }, {
        {11602775.971724393, 20096597.491866, 1.0},
        {11602775.971724393, 13397731.661244001, 1.0},
        {5801387.985862196, 16747164.576555002, 1.0}
    }, {
        {11602775.971724393, 20096597.491866, 1.0},
        {17404163.95758659, 23446030.407177, 1.0},
        {17404163.95758659, 16747164.576555002, 1.0}
    }, {
        {17404163.95758659, 23446030.407177, 1.0},
        {11602775.971724393, 26795463.322488002, 1.0},
        {17404163.95758659, 30144896.237799004, 1.0}
    }, {
        {11602775.971724393, 33494329.153110005, 1.0},
        {11602775.971724393, 26795463.322488002, 1.0},
        {5801387.985862196, 30144896.237799004, 1.0}
    }, {
        {5801387.985862196, 30144896.237799004, 1.0},
        {11602775.971724393, 26795463.322488002, 1.0},
        {5801387.985862196, 23446030.407177, 1.0}
    }, {
        {5801387.985862196, 16747164.576555002, 1.0},
        {0.0, 20096597.491866, 1.0},
        {5801387.985862196, 23446030.407177, 1.0}
    }, {
        {5801387.985862196, 16747164.576555002, 1.0},
        {5801387.985862196, 10048298.745933, 1.0},
        {0.0, 13397731.661244001, 1.0}
    }, {
        {5801387.985862196, 16747164.576555002, 1.0},
        {11602775.971724393, 13397731.661244001, 1.0},
        {5801387.985862196, 10048298.745933, 1.0}
    }, {
        {5801387.985862196, 10048298.745933, 1.0},
        {11602775.971724393, 13397731.661244001, 1.0},
        {11602775.971724393, 6698865.830622001, 1.0}
    }, {
        {11602775.971724393, 6698865.830622001, 1.0},
        {11602775.971724393, 13397731.661244001, 1.0},
        {17404163.95758659, 10048298.745933, 1.0}
    }, {
        {11602775.971724393, 0.0, 1.0},
        {11602775.971724393, 6698865.830622001, 1.0},
        {17404163.95758659, 3349432.9153110003, 1.0}
    }, {
        {0.0, 33494329.153110005, 1.0},
        {5801387.985862196, 30144896.237799004, 1.0},
        {0.0, 26795463.322488002, 1.0}
    }, {
        {0.0, 6698865.830622001, 1.0},
        {0.0, 13397731.661244001, 1.0},
        {5801387.985862196, 10048298.745933, 1.0}
    }, {
        {5801387.985862196, 3349432.9153110003, 1.0},
        {5801387.985862196, 10048298.745933, 1.0},
        {11602775.971724393, 6698865.830622001, 1.0}
    }, {
        {5801387.985862196, 3349432.9153110003, 1.0},
        {11602775.971724393, 6698865.830622001, 1.0},
        {11602775.971724393, 0.0, 1.0}
    }, {
        {5801387.985862196, 30144896.237799004, 1.0},
        {2900693.992931098, 31819612.695454504, 1.0},
        {5801387.985862196, 36843762.068421006, 1.0}
    }, {
        {5801387.985862196, 3349432.9153110003, 1.0},
        {11602775.971724393, 0.0, 1.0},
        {5801387.985862196, 0.0, 1.0}
    }, {
        {0.0, 26795463.322488002, 1.0},
        {5801387.985862196, 30144896.237799004, 1.0},
        {3867591.9905747976, 26795463.322488002, 1.0}
    }, {
        {5801387.985862196, 30144896.237799004, 1.0},
        {5801387.985862196, 23446030.407177, 1.0},
        {3867591.9905747976, 26795463.322488002, 1.0}
    }, {
        {0.0, 20096597.491866, 1.0},
        {1933795.9952873988, 23446030.407177, 1.0},
        {5801387.985862196, 23446030.407177, 1.0}
    }
};

constexpr double dym_ico_trans[23][3][3] = {
    {
        { 9.058433279771384e-08, 1.4731493732699052e-08, -0.9269301899999991},
        { -9.44826679987233e-08, 1.1304527499839262e-07, -1.0974189099999994},
        { -8.662754779110161e-08, -1.0789150406568015e-07, 4.077454709999999}
    },{
        { 1.5240780519329358e-07, 1.473149373269901e-08, -1.6442540899999978},
        { -3.4333093302050216e-08, 1.1304527499839258e-07, -1.7953209499999985},
        { -1.51633738709386e-08, -1.0789150406568015e-07, 3.248271909999998}
    },{
        { 1.525878853745444e-07, 1.504340175606161e-08, -1.6526118100000007},
        { -1.0166102516109274e-08, 1.5490373090569122e-07, -2.9169376700000003},
        { 3.536121881520939e-08, -2.0380342501548998e-08, 0.9033697899999995}
    },{
        { 1.557252983599121e-07, 9.609243061078464e-09, -1.5798064100000002},
        { -1.7245441994882394e-10, 1.375942246501773e-07, -2.6850295500000003},
        { -1.96578129712955e-08, 7.491541593592458e-08, -0.37337721000000035}
    },{
        { 4.399688326690425e-08, 9.54233233151121e-08, -2.0080176699999996},
        { -9.404803666461074e-08, 1.122924714451482e-07, -1.0873330499999996},
        { -1.1771180391040664e-07, -5.405199315156007e-08, 3.3561273899999997}
    },{
        { 4.074817450170371e-08, -7.158726449003567e-08, 1.9642587099999982},
        { -1.1897770528054373e-07, 7.061862589298568e-08, 0.3236332400000001},
        { -9.391868744648748e-08, -1.2052012839388902e-07, 4.500442009999996}
    },{
        { 1.5046877525297362e-07, -5.046779687011883e-10, -1.2134956799999999},
        { -4.0509505754953036e-08, -6.772840231043597e-08, 3.120257019999999},
        { 1.8840259480379495e-08, -1.4159603341569342e-07, 3.7568638499999985}
    },{
        { 1.55836594139745e-07, 8.792657069014762e-09, -1.52490368},
        { 1.4763566099823772e-08, 2.800736643244269e-08, -0.08634832999999958},
        { 1.1568102351290336e-08, -1.5419177904390005e-07, 4.178749899999998}
    },{
        { 9.134716490113195e-08, 1.504340175606163e-08, -1.2973306300000003},
        { 7.890345398644546e-09, 1.5490373090569127e-07, -3.021690130000001},
        { 1.2739806091251417e-07, -2.0380342501549028e-08, 0.3694283599999999}
    },{
        { 8.237047688665845e-08, 5.04677968701152e-10, -1.0017709799999996},
        { -1.2064637664394705e-07, 6.772840231043599e-08, -0.8160591599999997},
        { 5.741414913322641e-08, 1.4159603341569342e-07, -1.937212839999999}
    },{
        { 1.504687752529736e-07, 5.046779687011514e-10, -1.3968356299999996},
        { -4.0509505754953036e-08, 6.772840231043597e-08, -1.2809642399999992},
        { 1.8840259480379524e-08, 1.415960334156934e-07, -1.713430739999999}
    },{
        { 1.55836594139745e-07, -8.792657069014724e-09, -1.3345540299999996},
        { 1.4763566099823759e-08, -2.8007366432442684e-08, -0.6396431699999997},
        { 1.1568102351290311e-08, 1.5419177904390013e-07, -1.7978079499999997}
    },{
        { 1.0510891988020954e-07, -8.792657069014762e-09, -0.7459721899999996},
        { 1.1349411668458604e-07, -2.8007366432442694e-08, -1.7851916299999993},
        { 2.6608799545245027e-08, 1.541917790439001e-07, -1.9723217899999996}
    },{
        { 9.134716490113195e-08, -1.5043401756061595e-08, -0.5444247299999998},
        { 7.890345398644617e-09, -1.5490373090569122e-07, 0.29016699000000007},
        { 1.2739806091251412e-07, 2.038034250154901e-08, -2.2453721499999992}
    },{
        { 6.064058047097081e-08, 8.58140802540336e-08, -3.294437479999999},
        { 1.4427215125754238e-07, -2.530175320502907e-08, 0.7693199999999997},
        { 1.2045502760769865e-08, -1.2896740908748457e-07, 3.4155942999999986}
    },{
        { 3.2534318590648264e-08, -8.581408025403363e-08, 0.15470457999999998},
        { -1.4514141392576755e-07, 2.530175320502908e-08, -0.2476383},
        { 5.01230094778404e-08, 1.289674090874846e-07, -1.7680179200000001}
    },{
        { 1.524078051932937e-07, -1.4731493732699067e-08, -1.25498709},
        { -3.433309330205022e-08, -1.1304527499839266e-07, 0.49967191},
        { -1.5163373870938614e-08, 1.0789150406568026e-07, -1.17748929}
    },{
        { 1.5258788537454444e-07, -1.50434017560616e-08, -1.25498709},
        { -1.016610251610931e-08, -1.5490373090569122e-07, 0.49967191},
        { 3.536121881520941e-08, 2.0380342501549018e-08, -1.17748929}
    },{
        { 8.618449605826386e-08, 1.3005744286105568e-07, -4.776339219999996},
        { 1.1907386502737676e-07, -6.894646223375916e-08, 2.2311702599999985},
        { 5.5049746849940485e-08, -5.4481873383947436e-08, 0.9207512499999986}
    },{
        { 1.5572529749804938e-07, -9.609244553868475e-09, -1.29138978},
        { -1.7245528181154292e-10, -1.3759422614296728e-07, 0.38371785999999997},
        { -1.9657812971295542e-08, -7.491541593592457e-08, -0.53911579}
    },{
        { 1.0510892074207234e-07, 8.792655576224747e-09, -1.2306127199999985},
        { 1.1349411496086066e-07, 2.8007369418022736e-08, -0.6591226399999993},
        { 2.6608799545244997e-08, -1.5419177904390008e-07, 4.091492979999998}
    },{
        { 1.0510891815648413e-07, 8.79265706901476e-09, -1.2306127500000001},
        { 1.1349412013203696e-07, 2.8007366432442717e-08, -0.6591225800000001},
        { 2.6608799545245066e-08, -1.5419177904390005e-07, 4.091492979999997}
    },{
        { 4.4939794689710465e-08, 9.54233248079021e-08, -2.9126935899999995},
        { 3.249196924242356e-08, 1.1229246845956814e-07, -2.1653487399999993},
        { 1.4683839747935709e-07, -5.405199315156002e-08, 1.0461139699999995}
    }
};


inline double det(const PJ_XYZ *u, const PJ_XYZ *v, const PJ_XYZ *w) {
    return (
        u->x * (v->y * w->z - v->z * w->y) -
        v->x * (u->y * w->z - u->z * w->y) +
        w->x * (u->y * v->z - u->z * v->y)
    );
}

inline bool is_point_in_face(const PJ_XYZ *p, const pj_face * face) {
    return (
        det(p, &face->p2, &face->p3) < 0 &&
        det(&face->p1, p, &face->p3) < 0 &&
        det(&face->p1, &face->p2, p) < 0
    );
}


inline unsigned char get_ico_face_index(const PJ_XYZ *p) {
    for (unsigned char i=0; i < 23; i++) {
        if (is_point_in_face(p, &ico_faces[i])) {
            return i;
        }
    }

    return 23;
}

inline unsigned char get_dym_face_index(const PJ_XY *p) {
    const PJ_XYZ pp{p->x, p->y, 1.0};
    for (unsigned char i=0; i < 23; i++) {
        if (is_point_in_face(&pp, &dymaxion_faces[i])) {
            return i;
        }
    }

    return 23;
}

inline PJ_XY ico_to_dym(const PJ_XYZ * p, unsigned char face_id) {
    return PJ_XY{
        ico_dym_trans[face_id][0][0] * p->x +
        ico_dym_trans[face_id][0][1] * p->y +
        ico_dym_trans[face_id][0][2] * p->z +
        ico_dym_trans[face_id][0][3],
        ico_dym_trans[face_id][1][0] * p->x +
        ico_dym_trans[face_id][1][1] * p->y +
        ico_dym_trans[face_id][1][2] * p->z +
        ico_dym_trans[face_id][1][3],
    };
}

inline PJ_XYZ dym_to_ico(const PJ_XY * p, unsigned char face_id) {
    return PJ_XYZ{
        dym_ico_trans[face_id][0][0] * p->x +
        dym_ico_trans[face_id][0][1] * p->y +
        dym_ico_trans[face_id][0][2],
        dym_ico_trans[face_id][1][0] * p->x +
        dym_ico_trans[face_id][1][1] * p->y +
        dym_ico_trans[face_id][1][2],
        dym_ico_trans[face_id][2][0] * p->x +
        dym_ico_trans[face_id][2][1] * p->y +
        dym_ico_trans[face_id][2][2],
    };
}

inline PJ_XYZ cartesian_to_ico(const PJ_XYZ *p, unsigned char face_id) {
    const PJ_XYZ * center = &ico_centers[face_id];
    const PJ_XYZ * normal = &ico_normals[face_id];

    double a = 1.0 - (
        center->x * normal->x +
        center->y * normal->y +
        center->z * normal->z
    ) / (
        p->x * normal->x +
        p->y * normal->y +
        p->z * normal->z
    );

    return PJ_XYZ{
        p->x - a * p->x,
        p->y - a * p->y,
        p->z - a * p->z,
    };
}


// ============================================
//
//      The Forward and Inverse Functions
//
// ============================================
static PJ_XY dymaxion_forward(PJ_LP lp, PJ *P) {
    double lat;

    /* Convert the geodetic latitude to a geocentric latitude.
     * This corresponds to the shift from the ellipsoid to the sphere
     * described in [LK12]. */
    if (P->es != 0.0) {
        double one_minus_f = 1.0 - (P->a - P->b) / P->a;
        double one_minus_f_squared = one_minus_f * one_minus_f;
        lat = atan(one_minus_f_squared * tan(lp.phi));
    } else {
        lat = lp.phi;
    }

    // Convert the lat/long to x,y,z on the unit sphere
    double x, y, z;
    double sinlat, coslat;
    double sinlon, coslon;

    sinlat = sin(lat);
    coslat = cos(lat);
    sinlon = sin(lp.lam);
    coslon = cos(lp.lam);
    x = coslat * coslon;
    y = coslat * sinlon;
    z = sinlat;

    PJ_XYZ cartesianPoint{x, y, z};

    // printf("CARTESIAN: %lf, %lf, %lf\n", x, y, z);

    unsigned char face_id = get_ico_face_index(&cartesianPoint);
    // printf("FACE ID: %d\n", face_id);

    PJ_XYZ icoPoint = cartesian_to_ico(&cartesianPoint, face_id);

    // printf("ICO: %lf, %lf, %lf\n", icoPoint.x, icoPoint.y, icoPoint.z);


    PJ_XY dymaxionPoint = ico_to_dym(&icoPoint, face_id);

    // printf("PROJ OUT: %lf, %lf\n", dymaxionPoint.x, dymaxionPoint.y);


    return dymaxionPoint;
}


static PJ_LP dymaxion_inverse(PJ_XY xy, PJ *P) {
    PJ_LP lp = {0.0, 0.0};

    // printf("INVPROJ IN: %lf, %lf\n", xy.x, xy.y);


    unsigned char face_id = get_dym_face_index(&xy);
    // printf("FACE ID: %d\n", face_id);

    if (face_id == 23) {
      lp.lam = HUGE_VAL;
      lp.phi = HUGE_VAL;
      return lp;
    }


    PJ_XYZ sphereCoords = dym_to_ico(&xy, face_id);

    // printf("ICO: %lf, %lf, %lf\n", sphereCoords.x, sphereCoords.y, sphereCoords.z);
    // unsigned char other_face_id = get_ico_face_index(&sphereCoords);
    // printf("OTHER FACE ID: %d\n", other_face_id);

    double norm = sqrtl((sphereCoords.x * sphereCoords.x) + (sphereCoords.y * sphereCoords.y) + (sphereCoords.z * sphereCoords.z));
    double q = sphereCoords.x / norm;
    double r = sphereCoords.y / norm;
    double s = sphereCoords.z / norm;

    // printf("CARTESIAN: %lf, %lf, %lf\n", q, r, s);

    // Get the spherical angles from the x y z
    lp.phi = acos(-s) - M_HALFPI;
    lp.lam = atan2(r, q);

    // printf("SPHERE: %lf, %lf\n", lp.phi, lp.lam);


    /* Apply the shift from the sphere to the ellipsoid as described
     * in [LK12]. */
    if (P->es != 0.0) {
        int invert_sign;
        volatile double tanphi, xa;
        invert_sign = (lp.phi < 0.0 ? 1 : 0);
        tanphi = tan(lp.phi);
        double one_minus_f = 1.0 - (P->a - P->b) / P->a;
        double a_squared = P->a * P->a;
        xa = P->b / sqrt(tanphi * tanphi + one_minus_f * one_minus_f);
        lp.phi = atan(sqrt(a_squared - xa * xa) / (one_minus_f * xa));
        if (invert_sign) {
            lp.phi = -lp.phi;
        }
    }

    // printf("INVPROJ OUT (phi, lam): %lf, %lf\n", lp.phi, lp.lam);


    return lp;
}

PJ *PJ_PROJECTION(dymaxion) {
    P->left = PJ_IO_UNITS_RADIANS;
    P->right = PJ_IO_UNITS_PROJECTED;
    P->from_greenwich = -P->lam0;

    P->inv = dymaxion_inverse;
    P->fwd = dymaxion_forward;

    return P;
}
