

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Threads &mdash; proj.4 4.9.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="proj.4 4.9.3 documentation" href="../index.html"/>
        <link rel="up" title="Development" href="index.html"/>
        <link rel="next" title="Language bindings" href="bindings.html"/>
        <link rel="prev" title="API" href="api.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> proj.4
          

          
          </a>

          
            
            
              <div class="version">
                4.9.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projections/index.html">Projections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geodesic.html">Geodesic Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grids.html">Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../htpd.html">HTPD</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Threads</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#key-thread-safety-issues">Key Thread Safety Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#projctx">projCtx</a></li>
<li class="toctree-l3"><a class="reference internal" href="#src-multistresstest-c">src/multistresstest.c</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="bindings.html">Language bindings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">proj.4</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Development</a> &raquo;</li>
        
      <li>Threads</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="threads">
<span id="id1"></span><h1>Threads<a class="headerlink" href="#threads" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#threads" id="id2">Threads</a><ul>
<li><a class="reference internal" href="#key-thread-safety-issues" id="id3">Key Thread Safety Issues</a></li>
<li><a class="reference internal" href="#projctx" id="id4">projCtx</a></li>
<li><a class="reference internal" href="#src-multistresstest-c" id="id5">src/multistresstest.c</a></li>
</ul>
</li>
</ul>
</div>
<p>This page is about efforts to make PROJ.4 thread safe.</p>
<div class="section" id="key-thread-safety-issues">
<h2>Key Thread Safety Issues<a class="headerlink" href="#key-thread-safety-issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>the global pj_errno variable is shared between threads and makes it
essentially impossible to handle errors safely.  Being addressed with the
introduction of the projCtx execution context.</li>
<li>the datum shift using grid files uses globally shared lists of loaded grid
information. Access to this has been made safe in 4.7.0 with the introduction
of a proj.4 mutex used to protect access to these memory structures (see
pj_mutex.c).</li>
</ul>
</div>
<div class="section" id="projctx">
<h2>projCtx<a class="headerlink" href="#projctx" title="Permalink to this headline">¶</a></h2>
<p>Primarily in order to avoid having pj_errno as a global variable, a &#8220;thread
context&#8221; structure has been introduced into a variation of the PROJ.4 API for
the 4.8.0 release.  The pj_init() and pj_init_plus() functions now have context
variations called pj_init_ctx() and pj_init_plus_ctx() which take a projections
context.</p>
<p>The projections context can be created with pj_ctx_alloc(), and there is a
global default context used when one is not provided by the application.  There
is a pj_ctx_ set of functions to create, manipulate, query, and destroy
contexts.  The contexts are also used now to handle setting debugging mode, and
to hold an error reporting function for textual error and debug messages.   The
API looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">projPJ</span> <span class="n">pj_init_ctx</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span> <span class="p">);</span>
<span class="n">projPJ</span> <span class="n">pj_init_plus_ctx</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span> <span class="p">);</span>

<span class="n">projCtx</span> <span class="n">pj_get_default_ctx</span><span class="p">(</span><span class="n">void</span><span class="p">);</span>
<span class="n">projCtx</span> <span class="n">pj_get_ctx</span><span class="p">(</span> <span class="n">projPJ</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_set_ctx</span><span class="p">(</span> <span class="n">projPJ</span><span class="p">,</span> <span class="n">projCtx</span> <span class="p">);</span>
<span class="n">projCtx</span> <span class="n">pj_ctx_alloc</span><span class="p">(</span><span class="n">void</span><span class="p">);</span>
<span class="n">void</span>    <span class="n">pj_ctx_free</span><span class="p">(</span> <span class="n">projCtx</span> <span class="p">);</span>
<span class="nb">int</span> <span class="n">pj_ctx_get_errno</span><span class="p">(</span> <span class="n">projCtx</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_errno</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="nb">int</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_debug</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="nb">int</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_logger</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">void</span> <span class="o">*</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_app_data</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span> <span class="p">);</span>
<span class="n">void</span> <span class="o">*</span><span class="n">pj_ctx_get_app_data</span><span class="p">(</span> <span class="n">projCtx</span> <span class="p">);</span>
</pre></div>
</div>
<p>Multithreaded applications are now expected to create a projCtx per thread
using pj_ctx_alloc().  The context&#8217;s error handlers, and app data may be
modified if desired, but at the very least each context has an internal error
value accessed with pj_ctx_get_errno() as opposed to looking at pj_errno.</p>
<p>Note that pj_errno continues to exist, and it is set by pj_ctx_set_errno() (as
well as setting the context specific error number), but pj_errno still suffers
from the global shared problem between threads and should not be used by
multithreaded applications.</p>
<p>Note that pj_init_ctx(), and pj_init_plus_ctx() will assign the projCtx to the
created projPJ object.  Functions like pj_transform(), pj_fwd() and pj_inv()
will use the context of the projPJ for error reporting.</p>
</div>
<div class="section" id="src-multistresstest-c">
<h2>src/multistresstest.c<a class="headerlink" href="#src-multistresstest-c" title="Permalink to this headline">¶</a></h2>
<p>A small multi-threaded test program has been written (src/multistresstest.c)
for testing multithreaded use of PROJ.4.  It performs a series of reprojections
to setup a table expected results, and then it does them many times in several
threads to confirm that the results are consistent.  At this time this program
is not part of the builds but it can be built on linux like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">g</span> <span class="n">multistresstest</span><span class="o">.</span><span class="n">c</span> <span class="o">.</span><span class="n">libs</span><span class="o">/</span><span class="n">libproj</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">lpthread</span> <span class="o">-</span><span class="n">o</span> <span class="n">multistresstest</span>
<span class="o">./</span><span class="n">multistresstest</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bindings.html" class="btn btn-neutral float-right" title="Language bindings" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="api.html" class="btn btn-neutral" title="API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 1986?-2016.
      Last updated on 25 Nov 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'4.9.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>